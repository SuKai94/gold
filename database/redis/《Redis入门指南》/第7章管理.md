第7章 管理
===

### 7.1 持久化

为了使Redis在重启之后仍能保证数据不丢失，需要将数据从内存中以某种形式同步到硬盘中，就是持久化操作

Redis支持两种持久化操作，RDB和AOF两种方式，可以单独使用其中一种或者二者结合使用

#### 7.1.1 RDB方式

RDB持久化是通过快照完成的，当符合一定条件Redis会自动将内存中所有数据进行快照并存储在硬盘上

一定条件由用户在配置文件中自定义，两个参数构成：时间和改动的键的个数

RDB是Redis默认采用的持久化方式，在配置文件中预置了三个条件

```
save 900 1
save 300 10
save 60 10000
```

`save 900 1`指的是，在15分钟内（900s）至少有一个键被更改则进行快照

Redis默认将快照文件存储在当前目录的dump.rdb，可以通过`dir`和`dbfilename`两个参数指定快照文件的存储路径和文件名

**快照是如何进行的：**

- 通过fork函数复制当前父进程的子进程
- 父进程继续接受客户端发来的命令，子进程开始将内存中的数据写入硬盘中的临时文件
- 当子进程写完所有数据，会用该临时文件替换旧的RDB文件，快照完成

执行fork时，操作系统使用写时复制策略，即fork函数发生的那一刻父子进程共享内存数据，当父进程更改其中某数据，操作系统会将该片数据复制一份以保证子进程数据不受影响

缺点：一旦Redis异常退出，就会丢失最后一次快照以后更改的所有数据

如果数据十分重要，无法忍受，建议采用AOF方式

#### 7.1.2 AOF方式

默认Redis未开启AOF，采用`appendonly yes`开启

开启AOF后，每执行一条会更改Redis数据的命令，就会将该命令写入AOF文件，默认文件名是`appendonly.aof`

AOF文件是纯文本文件，内容就是Redis客户端向Redis发送的原始通信协议的内容。随着执行命令越来越多，AOF文件会越来越大，我们就希望自动优化AOF文件（比如前2条命令会被第3条命令覆盖，前2条命令就是冗余的）。所以，当到达一定条件，Redis就会自动重写AOF文件，可以在配置文件中配置：

```
auto-aof-rewrite-percentage 100 #当前AOF文件超过重写时AOF文件的百分之多少时就会重写
auto-aof-rewrite-min-size 64mb  #限制重写的最小AOF文件大小
```

**需要注意的是**，AOF都会将命令记录在AOF文件中，但是事实上，由于操作系统的缓存机制，数据并没有真正地写入硬盘，而是进入了系统的硬盘缓存。在默认情况下，系统每30s执行一次同步操作，以便将硬盘缓存中的内容真正地写入硬盘中。

30s内如果Redis异常退出，则会丢失数据，可以通过`appendfsync`参数设置同步的时机：

```
# appendfsync always
appendfsync everysec
# appendfsync no
```

- 默认采用`everysec`，每秒执行一次同步操作
- `always`表示每次写入都会执行同步，最安全也是最慢的方式
- `no`表示不主动进行同步，完全由操作新系统来做（30s每次）
